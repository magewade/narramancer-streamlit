import os
from dotenv import load_dotenv
from langchain_mistralai import ChatMistralAI
from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder
from langchain_core.output_parsers import StrOutputParser
from langchain_core.runnables.history import RunnableWithMessageHistory
import sqlalchemy
import re
from langchain_community.chat_message_histories import SQLChatMessageHistory


# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()


# –ö–ª–∞—Å—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —á–∞—Ç-–±–æ—Ç–æ–º D&D
class DNDChatbot:
    def __init__(self):
        # –ü–æ–ª—É—á–µ–Ω–∏–µ API –∫–ª—é—á–∞
        self.api_key = os.getenv("MISTRAL_API_KEY")

        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —è–∑—ã–∫–æ–≤–æ–π –º–æ–¥–µ–ª–∏
        self.llm = ChatMistralAI(
            model="mistral-large-latest",
            temperature=0.7,  # –ù–µ–º–Ω–æ–≥–æ –ø–æ–≤—ã—à–µ–Ω–Ω–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–ª—è –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏
        )

        # –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è D&D –±–æ—Ç–∞
        self.system_prompt = """–¢—ã Narramancer - –º–∞—Å—Ç–µ—Ä –¥–ª—è –Ω–∞—Å—Ç–æ–ª—å–Ω–æ–π —Ä–æ–ª–µ–≤–æ–π –∏–≥—Ä—ã, –ø–æ—Ö–æ–∂–µ–π –Ω–∞ Dungeons & Dragons.
                                –¢–≤–æ–∏ –∑–∞–¥–∞—á–∏:
                                - –°–æ–∑–¥–∞–≤–∞—Ç—å —É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–µ –∏ –¥–∏–Ω–∞–º–∏—á–Ω—ã–µ —Å—é–∂–µ—Ç–Ω—ã–µ –ø–æ–≤–æ—Ä–æ—Ç—ã
                                - –û–ø–∏—Å—ã–≤–∞—Ç—å –æ–∫—Ä—É–∂–µ–Ω–∏–µ, –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –∏ —Å–æ–±—ã—Ç–∏—è
                                - –ü–æ–º–æ–≥–∞—Ç—å –∏–≥—Ä–æ–∫–∞–º –ø–æ–≥—Ä—É–∑–∏—Ç—å—Å—è –≤ –º–∏—Ä –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–π
                                - –°–ª–µ–¥–∏—Ç—å –∑–∞ –ø—Ä–∞–≤–∏–ª–∞–º–∏ –∏ –º–µ—Ö–∞–Ω–∏–∫–æ–π –∏–≥—Ä—ã
                                - –ò–≥—Ä–æ–∫ –Ω–∞—á–∏–Ω–∞–µ—Ç —Å –≤–≤–µ–¥–µ–Ω–∏—è —Å–≤–æ–µ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞, –µ—Å–ª–∏ –æ–Ω –Ω–∞—á–∏–Ω–∞–µ—Ç —Å —á–µ–≥–æ-—Ç–æ –¥—Ä—É–≥–æ–≥–æ, –ø—Ä–µ–¥–ª–æ–∂–∏ –µ–º—É —Å–æ–∑–¥–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
                                - –ù–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ –æ–ø–∏—Å–∞–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –°–ê–ú —Å–æ—Å—Ç–∞–≤—å –ª–∏—Å—Ç —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –∏ –ø–æ–∫–∞–∂–∏ –µ–≥–æ –∏–≥—Ä–æ–∫—É
                                - –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –≤–ª–∏—è—é—Ç –Ω–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –∏ –µ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –≤ –∏–≥—Ä–µ
                                –•–ê–†–ê–ö–¢–ï–†–ò–°–¢–ò–ö–ò:
                                    1. **–°–∏–ª–∞** (Strength) - —Ñ–∏–∑–∏—á–µ—Å–∫–∞—è –º–æ—â—å –∏ –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å.
                                    2. **–õ–æ–≤–∫–æ—Å—Ç—å** (Dexterity) - –≥–∏–±–∫–æ—Å—Ç—å –∏ —Ä–µ—Ñ–ª–µ–∫—Å—ã.
                                    3. **–¢–µ–ª–æ—Å–ª–æ–∂–µ–Ω–∏–µ** (Constitution) - –∑–¥–æ—Ä–æ–≤—å–µ –∏ –∂–∏–≤—É—á–µ—Å—Ç—å.
                                    4. **–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç** (Intelligence) - —É–º—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –∏ –∑–Ω–∞–Ω–∏—è.
                                    5. **–ú—É–¥—Ä–æ—Å—Ç—å** (Wisdom) - –∏–Ω—Ç—É–∏—Ü–∏—è –∏ –≤–Ω–∏–º–∞–Ω–∏–µ –∫ –¥–µ—Ç–∞–ª—è–º.
                                    6. **–•–∞—Ä–∏–∑–º–∞** (Charisma) - –ª–∏–¥–µ—Ä—Å–∫–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ –∏ —É–±–µ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å.
                                - –ö–∞–∂–¥–∞—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –æ—Ç 1 –¥–æ 20.
                                - –¢–∞–∫–∂–µ –µ—Å—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä HP, –∫–æ—Ç–æ—Ä—ã–π –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∂–∏–∑–Ω–µ–π –ø–µ—Ä—Å–æ–Ω–∞–∂–∞.
                                –•–ü=–ë–∞–∑–æ–≤—ã–π¬†–ø–æ–∫–∞–∑–∞—Ç–µ–ª—å+–¢–µ–ª–æ—Å–ª–æ–∂–µ–Ω–∏–µ√ó3+–°–∏–ª–∞√ó1.5+–õ–æ–≤–∫–æ—Å—Ç—å√ó1.2+–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç√ó0.5+–ú—É–¥—Ä–æ—Å—Ç—å√ó0.5+–•–∞—Ä–∏–∑–º–∞√ó0.5
                                - –ü—Ä–∏ –∞—Ç–∞–∫–µ –≤—Ä–∞–≥–æ–≤, —Ç–µ–±–µ –Ω–∞–¥–æ –≤—ã—á–∏—Ç–∞—Ç—å –∏–∑ HP –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Ä–æ–Ω–∞ –∏ –∑–∞–¥–∞—Ç—å —Ö–∏—Ç, –µ—Å–ª–∏ HP<0, —Ç–æ –∏–≥—Ä–æ–∫ –ø–æ–≥–∏–±–∞–µ—Ç
                                - –ò–≥—Ä–æ–∫ –º–æ–∂–µ—Ç –ª–µ—á–∏—Ç—å—Å—è –∑–µ–ª—å—è–º–∏ –∏–ª–∏ –º–∞–≥–∏–µ–π, –Ω–æ —É –Ω–∏—Ö –µ—Å—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è, –∏–Ω–æ–≥–¥–∞ –º–æ–≥—É—Ç—å –ø–æ—è–≤–∏—Ç—Å—è –ø–ª–æ—Ö–∏–µ —ç—Ñ—Ñ–µ–∫—Ç—ã (–º–æ–∂–µ—à—å –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∫–∏–¥–∞—Ç—å –∫—É–±–∏–∫)
                                - –í –Ω–∞—á–∞–ª–µ –∏–≥—Ä—ã –Ω–∞–ø–∏—à–∏ –¥–ª—è –∏–≥—Ä–æ–∫–∞ —Å–ø–∏—Å–æ–∫ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫, –∞ —Ç–∞–∫–∂–µ –µ–≥–æ –∏–º—è, —Ä–∞—Å—É, –∫–ª–∞—Å—Å, –æ—Ä—É–∂–∏–µ, –≤–Ω–µ—à–Ω–æ—Å—Ç—å, –∫—Ä–∞—Ç–∫–æ –ø—Ä–µ–¥—ã—Å—Ç–æ—Ä–∏—é, –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º—ã–µ –∏–º–µ—é—â–∏–µ—Å—è –ø—Ä–µ–¥–º–µ—Ç—ã –∏ –º–∞–≥–∏—é
                                - –ò—Å—Ö–æ–¥—è –∏–∑ –æ–ø–∏—Å–∞–Ω–∏—è, —Ç—ã –º–æ–∂–µ—à—å —Ä–µ—à–∞—Ç—å —Å–∫–æ–ª—å–∫–æ —É –∏–≥—Ä–æ–∫–∞ –∏–º–µ–µ—Ç—Å—è —Å —Å–æ–±–æ–π –º–æ–Ω–µ—Ç - –æ—Ç 0 –¥–æ 1000 
                                - –ú–æ–Ω–µ—Ç—ã —Ç—Ä–∞—Ç—è—Ç—Å—è –≤ —Ç–∞–≤–µ—Ä–Ω–∞—Ö, –º–∞–≥–∞–∑–∏–Ω–∞—Ö –∏–ª–∏ –∏—Ö –º–æ–≥—É—Ç —É–∫—Ä–∞—Å—Ç—å
                                - –¢—ã –Ω–µ —Ä–µ—à–∞–µ—à—å –∑–∞ –∏–≥—Ä–æ–∫–∞, —á—Ç–æ –µ–º—É –¥–µ–ª–∞—Ç—å –∏ –≥–æ–≤–æ—Ä–∏—Ç—å. –ö–∞–∂–¥—ã–π —Ä–∞–∑, –∫–æ–≥–¥–∞ –∏—Å—Ç–æ—Ä–∏—è –ø–æ–¥–≤–æ–¥–∏—Ç –∫ –≤—ã–±–æ—Ä—É, –ø—Ä–µ–¥–ª–æ–∂–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤, –Ω–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–∫–∞–∂–∏, —á—Ç–æ –∏–≥—Ä–æ–∫ –º–æ–∂–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Å–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç.
                                –í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê –ë–†–û–°–ö–û–í –ö–£–ë–ò–ö–û–í:
                                    1. –ö–æ–≥–¥–∞ –≤ —Ç–µ–∫—Å—Ç–µ –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç [roll:XdY], —ç—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –±—Ä–æ—Å–∫–∞ –∫—É–±–∏–∫–∞.
                                    2. X - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫—É–±–∏–∫–æ–≤, Y - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥—Ä–∞–Ω–µ–π.
                                    3. –ü—Ä–∏–º–µ—Ä—ã: [roll:1d20] - –æ–¥–∏–Ω –±—Ä–æ—Å–æ–∫ 20-–≥—Ä–∞–Ω–Ω–æ–≥–æ –∫—É–±–∏–∫–∞.
                                    4. –ù–ï –ü–û–î–°–¢–ê–í–õ–Ø–ô –†–ï–ó–£–õ–¨–¢–ê–¢ –ë–†–û–°–ö–ê –°–ê–ú.
                                    5. –í–°–ï–ì–î–ê –û–°–¢–ê–í–õ–Ø–ô –ú–ï–¢–ö–£ [roll:XdY] –î–õ–Ø –ò–ì–†–û–ö–ê.
                                    6. –ö—É–±–∏–∫ –±—Ä–æ—Å–∞–µ—Ç—Å—è –æ–¥–∏–Ω –∏ –Ω–∞ –æ–¥–Ω—É —Å–∏—Ç—É–∞—Ü–∏—é, –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É –æ–¥–Ω–æ–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫—É –∏–Ω–∏—Ü–∞–∏–≤–∞—Ç–∏–≤—ã.
                                    7. –î–ª—è –≤—Ä–∞–≥–æ–≤ –∏–≥—Ä–æ–∫ –±—Ä–æ—Å–∞—Ç—å –∫—É–±–∏–∫–∏ –ù–ï –î–û–õ–ñ–ï–ù, —Ä–µ—à–∞–π —á—Ç–æ –¥–µ–ª–∞—é—Ç –≤—Ä–∞–≥–∏ —Å–∞–º
                                    8. –ò–≥—Ä–æ–∫ –Ω–µ –º–æ–∂–µ—Ç –±—Ä–æ—Å–∏—Ç—å –±–æ–ª—å—à–µ 1 –∫—É–±–∏–∫–∞ –∑–∞ —Ä–∞–∑, —Ç–∞–∫ —á—Ç–æ –ª—É—á—à–µ –Ω–µ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –±—Ä–æ—Å–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫—É–±–∏–∫–æ–≤ –≤ –æ–¥–∏–Ω —Ö–æ–¥
                                - –ë–†–û–°–ö–ò –ö–£–ë–ò–ö–û–í –ù–ï –î–û–õ–ñ–ù–´ –ë–´–¢–¨ –ü–†–ò–ù–ò–ú–ê–ù–´, –ï–°–õ–ò –û–ù–ò –ù–ï –û–¢–ù–û–°–Ø–¢–°–Ø –ö –ü–†–û–í–ï–†–ö–ï, –ò–ù–ò–¶–ò–ê–¢–ò–í–ï, –ë–û–ï–í–´–ú –î–ï–ô–°–¢–í–ò–Ø–ú –ò–õ–ò –î–†–£–ì–ò–ú –ú–ï–•–ê–ù–ò–ö–ê–ú –ò–ì–†–´. –ù–ï –ü–†–û–ì–†–ê–ú–ú–ò–†–£–ô –ö–£–ë–ò–ö–ò –î–õ–Ø –û–ë–´–ß–ù–û–ì–û –ü–†–ï–î–°–ö–ê–ó–ê–ù–ò–Ø –°–ò–¢–£–ê–¶–ò–ò, –ö–ê–ö "–ß–¢–û –ñ–î–ï–¢ –ù–ê –î–û–†–û–ì–ï". –í –¢–ê–ö–ò–• –°–õ–£–ß–ê–Ø–• –ü–†–û–°–¢–û –û–ü–ò–®–ò –°–ò–¢–£–ê–¶–ò–Æ.
                                - –ù–ï –ò–ù–¢–ï–†–ü–†–ï–¢–ò–†–£–ô –ë–†–û–°–ö–ò –ö–£–ë–ò–ö–û–í –î–õ–Ø –†–ï–®–ï–ù–ò–Ø, –ö–£–î–ê –ò–î–¢–ò, –µ—Å–ª–∏ —ç—Ç–æ–≥–æ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è.
                                  –ï—Å–ª–∏ –≤—ã–±—Ä–æ—Å–∏—Ç—å –∫—É–±–∏–∫ –Ω—É–∂–Ω–æ –¥–ª—è —Ä–µ—à–µ–Ω–∏—è, –∫–∞–∫ –ø—Ä–æ–¥–≤–∏–≥–∞–µ—Ç—Å—è —Å—é–∂–µ—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—ã, –±–æ–µ–≤–æ–π –±—Ä–æ—Å–æ–∫ –∏ —Ç.–¥.), —Ç–æ–≥–¥–∞ –ø–æ–¥–æ–∂–¥–∏ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞.
                                - –ö–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –±—Ä–æ—Å–∏—Ç—å –∫—É–±–∏–∫, –ø—Ä–∏–æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π –¥–µ–π—Å—Ç–≤–∏–µ, –Ω–µ –¥–∞–≤–∞–π –∏–≥—Ä–æ–∫—É —Ä–µ—à–∞—Ç—å —á—Ç–æ –¥–µ–ª–∞—Ç—å, –ø–æ–∫–∞ –æ–Ω –Ω–µ –±—Ä–æ—Å–∏–ª –∫—É–±–∏–∫
                                - –ù–ï –ø—Ä–µ–¥–ª–∞–≥–∞–π –≤–∞—Ä–∏–∞–Ω—Ç—ã —Ä–∞–∑–≤–∏—Ç–∏—è —Å–æ–±—ã—Ç–∏–π –∏–ª–∏ –¥–µ–π—Å—Ç–≤–∏–π –¥–æ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –±—Ä–æ—Å–∫–∞.
                                - –ü–æ—Å–ª–µ –±—Ä–æ—Å–∫–∞ –∫—É–±–∏–∫–∞ –ø—Ä–æ–¥–æ–ª–∂–∏ –∏—Å—Ç–æ—Ä–∏—é –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞: –∑–Ω–∞—á–µ–Ω–∏–µ –∫—É–±–∏–∫–∞ + (–ª–æ–≥–∏—á–Ω–æ –±–ª–∏–∑–∫–∞—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ - 10 / 2) –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –±–æ–ª—å—à–µ 10 (—É—Å–ø–µ—Ö) - –Ω–µ –ø–∏—à–∏ –ø–æ–ª–Ω—É—é —Ñ–æ—Ä–º—É–ª—É –∏–≥—Ä–æ–∫—É, –ø—Ä–æ—Å—Ç–æ –ø–æ—Å–ª–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –±—Ä–æ—Å–∫–∞ –ø—Ä–æ–≥–æ–≤–æ—Ä–∏–≤–∞–π - —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–ª—é—Å –±–æ–Ω—É—Å –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏
                                - –ò–≥—Ä–æ–∫ –¥–æ–ª–∂–µ–Ω –±—Ä–æ—Å–∞—Ç—å –∫—É–±–∏–∫ —Ç–æ–ª—å–∫–æ –∑–∞ —Å–µ–±—è
                                - –ò–≥—Ä–æ–∫ –¥–æ–ª–∂–µ–Ω –≥–æ–≤–æ—Ä–∏—Ç—å –∑–∞ —Å–µ–±—è. –ù–µ –≥–æ–≤–æ—Ä–∏ –∑–∞ –∏–≥—Ä–æ–∫–∞! –î–∞–π –µ–º—É —Ä–µ—à–∏—Ç—å —Å–∞–º–æ–º—É –∫–∞–∫ –æ–Ω –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ —Ç–æ–π –∏–ª–∏ –∏–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏
                                - –ó–∞ —Ä–µ—à–µ–Ω–∏—è –∏ –¥–µ–π—Å—Ç–≤–∏—è NPC —Ä–µ—à–µ–Ω–∏—è –ø—Ä–∏–Ω–∏–º–∞–µ—à—å —Ç—ã
                                - –ù–µ –≥–æ–≤–æ—Ä–∏ –æ—Ç –ª–∏—Ü–∞ –∏–≥—Ä–æ–∫–∞, –∏–≥—Ä–æ–∫ –≥–æ–≤–æ—Ä–∏—Ç –∑–∞ —Å–µ–±—è
                                - –ë—É–¥—å —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤—ã–º –∏ —Å–æ–∑–¥–∞–≤–∞–π –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—é—â—É—é –∏—Å—Ç–æ—Ä–∏—é.
                                - –ù–µ –±—É–¥—å –∫–ª–∏—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–º, –ø—Ä–∏–¥—É–º—ã–≤–∞–π –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ —Å—é–∂–µ—Ç–Ω—ã–µ –ø–æ–≤–æ—Ä–æ—Ç—ã –∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π —Å —Å–µ—Ä–æ–π –º–æ—Ä–∞–ª—å—é. –ù–ï –≤—Å–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏ –¥–æ–ª–∂–Ω—ã —Å–æ–≥–ª–∞—à–∞—Ç—å—Å—è –∏–ª–∏ –∏–¥—Ç–∏ –Ω–∞ –ø–æ–≤–æ–¥—É —É –∏–≥—Ä–æ–∫–∞, –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –≥—Ä—É–±–∏—Ç—å, –Ω–∞—Å–º–µ—Ö–∞—Ç—å—Å—è –∏ –±—ã—Ç—å –Ω–µ–ø—Ä–∏—è—Ç–Ω—ã–º–∏ –ª–∏—á–Ω–æ—Å—Ç—è–º–∏ —Å —Å–µ—Ä–æ–π –º–æ—Ä–∞–ª—å—é
                                - –ò–Ω—Ç—Ä–∏–≥–∞ –∏ –ø–µ—Ä—á–∏–Ω–∫–∞ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–æ–º–µ—à–∞—é—Ç
                                - –ü–æ–ø—ã—Ç–∞–π—Å—è –≤–ª–µ–∑—Ç—å –≤ –ª–∏–º–∏—Ç –≤ 4000 —Å–∏–º–≤–æ–ª–æ–≤ –∑–∞ –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ (–º–æ–∂–Ω–æ –º–µ–Ω—å—à–µ, –Ω–æ –Ω–µ –±–æ–ª—å—à–µ).

                                –í–µ–¥–∏ —Å–µ–±—è –∫–∞–∫ –æ–ø—ã—Ç–Ω—ã–π —Ä–∞—Å—Å–∫–∞–∑—á–∏–∫ –∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–π."""

        # –°–ª–æ–≤–∞—Ä—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–æ–≤
        self.chat_histories = {}

        # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        os.makedirs("chat_histories", exist_ok=True)

        # –°–æ–∑–¥–∞–Ω–∏–µ —Ü–µ–ø–æ—á–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏
        self.chain = self.create_chain()

    def start_new_game(self, session_id: str):
        """–ú–µ—Ç–æ–¥ –¥–ª—è –Ω–∞—á–∞–ª–∞ –Ω–æ–≤–æ–π –∏–≥—Ä—ã —Å –æ—á–∏—Å—Ç–∫–æ–π –∏—Å—Ç–æ—Ä–∏–∏"""
        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –∏—Å—Ç–æ—Ä–∏—é
        history = self.get_session_history(session_id)

        # –û—á–∏—â–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
        history.clear()

    def create_chain(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ —Ü–µ–ø–æ—á–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å –∏—Å—Ç–æ—Ä–∏–µ–π —Å–æ–æ–±—â–µ–Ω–∏–π"""
        # –°–æ–∑–¥–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞ —á–∞—Ç–∞
        prompt = ChatPromptTemplate.from_messages(
            [
                ("system", self.system_prompt),
                MessagesPlaceholder(variable_name="chat_history"),
                ("human", "{player_input}"),
            ]
        )

        # –û—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–ø–æ—á–∫–∞ —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π roll
        from langchain_core.runnables import RunnablePassthrough

        base_chain = (
            RunnablePassthrough.assign(roll=lambda x: x.get("roll", ""))
            | prompt
            | self.llm
            | StrOutputParser()
        )

        # –°–æ–∑–¥–∞–Ω–∏–µ —Ü–µ–ø–æ—á–∫–∏ —Å –∏—Å—Ç–æ—Ä–∏–µ–π
        return RunnableWithMessageHistory(
            base_chain,
            self.get_session_history,
            input_messages_key="player_input",
            history_messages_key="chat_history",
            additional_variables=[
                "roll"
            ],  # –î–æ–±–∞–≤–ª—è–µ–º roll –∫–∞–∫ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
        )

    # –ò–∑–º–µ–Ω–∏–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –∫—É–±–∏–∫–∞–º–∏ –≤ –º–µ—Ç–æ–¥–µ interact

    def interact(
        self, player_input: str, session_id: str = "default_session", roll: str = None
    ):
        """–í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å —á–∞—Ç-–±–æ—Ç–æ–º —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –±—Ä–æ—Å–∫–æ–≤ –∫—É–±–∏–∫–∞"""
        try:
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ –±—Ä–æ—Å–∫–∞ –∫—É–±–∏–∫–∞
            roll_match = re.search(r"\[roll:(\d+)d(\d+)\]", player_input)

            if roll_match:
                # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –±—Ä–æ—Å–∫–∞
                num_dice = int(roll_match.group(1))
                dice_sides = int(roll_match.group(2))

                # –ï—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –±—Ä–æ—Å–∫–∞ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ
                if roll is None:
                    return f"üé≤ –¢–µ–±–µ –Ω—É–∂–Ω–æ –±—Ä–æ—Å–∏—Ç—å {num_dice}d{dice_sides}. –ù–∞–∂–º–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É –±—Ä–æ—Å–∫–∞!"

                # –ï—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –±—Ä–æ—Å–∫–∞ –ø–µ—Ä–µ–¥–∞–Ω, –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –µ–≥–æ
                roll_result = int(roll)

                # –û—Å—Ç–∞–≤–ª—è–µ–º –º–µ—Ç–∫—É –∫–∞–∫ –µ—Å—Ç—å
                modified_input = player_input  # –ù–µ –∑–∞–º–µ–Ω—è–µ–º –º–µ—Ç–∫—É

                # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –∏—Å—Ç–æ—Ä–∏–∏
                response = self.chain.invoke(
                    {"player_input": modified_input, "roll": str(roll_result)},
                    {"configurable": {"session_id": session_id}},
                )

                return response

            else:
                # –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º –±–µ–∑ –±—Ä–æ—Å–∫–∞
                response = self.chain.invoke(
                    {"player_input": player_input, "roll": ""},
                    {"configurable": {"session_id": session_id}},
                )
                return response

        except Exception as e:
            return f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}"

    def get_session_history(self, session_id: str):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º SQLite"""
        engine = sqlalchemy.create_engine("sqlite:///database/chat_history.db")
        return SQLChatMessageHistory(session_id=session_id, connection=engine)
