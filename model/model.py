import os
from dotenv import load_dotenv
from langchain_mistralai import ChatMistralAI
from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder
from langchain_core.output_parsers import StrOutputParser
from langchain_core.runnables.history import RunnableWithMessageHistory
import sqlalchemy
import re
from langchain_community.chat_message_histories import SQLChatMessageHistory


# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()


# –ö–ª–∞—Å—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —á–∞—Ç-–±–æ—Ç–æ–º D&D
class DNDChatbot:
    def __init__(self):
        # –ü–æ–ª—É—á–µ–Ω–∏–µ API –∫–ª—é—á–∞
        self.api_key = os.getenv("MISTRAL_API_KEY")

        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —è–∑—ã–∫–æ–≤–æ–π –º–æ–¥–µ–ª–∏
        self.llm = ChatMistralAI(
            model="mistral-large-latest",
            temperature=0.7,  # –ù–µ–º–Ω–æ–≥–æ –ø–æ–≤—ã—à–µ–Ω–Ω–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–ª—è –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏
        )

        self.system_prompt = (
            "–¢—ã Narramancer ‚Äî –≤–µ–¥—É—â–∏–π –∏ —Ä–∞—Å—Å–∫–∞–∑—á–∏–∫ –≤ —Ä–æ–ª–µ–≤–æ–π –∏–≥—Ä–µ, –≤–¥–æ—Ö–Ω–æ–≤–ª—ë–Ω–Ω–æ–π Dungeons & Dragons.\n\n"
            "–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å–æ–∑–¥–∞—Ç—å –∂–∏–≤–æ–π, –±–æ–≥–∞—Ç—ã–π, –Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–π –º–∏—Ä –¥–ª—è –∏–≥—Ä–æ–∫–∞, –≥–¥–µ –æ–Ω —Å–∞–º –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ä–µ—à–µ–Ω–∏—è, "
            "–¥–µ–π—Å—Ç–≤—É–µ—Ç, —Ä–∞–∑–≥–æ–≤–∞—Ä–∏–≤–∞–µ—Ç –∏ –±—Ä–æ—Å–∞–µ—Ç –∫—É–±–∏–∫–∏. –¢—ã ‚Äî –Ω–µ –≥–µ—Ä–æ–π –∏—Å—Ç–æ—Ä–∏–∏. –¢—ã ‚Äî –µ—ë —Å–æ–∑–¥–∞—Ç–µ–ª—å –∏ –≤–µ–¥—É—â–∏–π.\n\n"
            "üé≠ –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –∏–≥—Ä–æ–∫–æ–º:\n"
            "- –ù–µ –≥–æ–≤–æ—Ä–∏ –∑–∞ –∏–≥—Ä–æ–∫–∞. –ù–∏–∫–æ–≥–¥–∞. –ò–≥—Ä–æ–∫ –≥–æ–≤–æ—Ä–∏—Ç –∏ –¥–µ–π—Å—Ç–≤—É–µ—Ç —Å–∞–º. –¢—ã –Ω–µ –æ–ø–∏—Å—ã–≤–∞–µ—à—å, —á—Ç–æ –æ–Ω –¥—É–º–∞–µ—Ç, –≥–æ–≤–æ—Ä–∏—Ç –∏–ª–∏ –¥–µ–ª–∞–µ—Ç.\n"
            "- –ù–µ –ø—Ä–µ–¥–ª–∞–≥–∞–π –¥–µ–π—Å—Ç–≤–∏—è –∏ –±—Ä–æ—Å–∫–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ. –ï—Å–ª–∏ –Ω—É–∂–µ–Ω –±—Ä–æ—Å–æ–∫ –∫—É–±–∏–∫–∞ ‚Äî –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏ —Ö–æ–¥ –∏—Å—Ç–æ—Ä–∏–∏ –∏ –¥–∞–π —Ç–æ–ª—å–∫–æ –º–µ—Ç–∫—É [roll:XdY]. "
            "–¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –±—Ä–æ—Å–∫–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–π –∏—Å—Ç–æ—Ä–∏—é –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã –∏–ª–∏ –∂–¥–∏ –æ—Ç–≤–µ—Ç–∞ –∏–≥—Ä–æ–∫–∞.\n"
            "- –ü—Ä–∏ –∫–∞–∂–¥–æ–º –≤—ã–±–æ—Ä–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–æ–±–∞–≤–ª—è–π: '–¢—ã –º–æ–∂–µ—à—å –≤—ã–±—Ä–∞—Ç—å –æ–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –∏–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Å–≤–æ–π.'\n\n"
            "üßë‚Äçüé§ –ü–µ—Ä—Å–æ–Ω–∞–∂:\n"
            "- –í –Ω–∞—á–∞–ª–µ –∏–≥—Ä–æ–∫ –æ–ø–∏—Å—ã–≤–∞–µ—Ç —Å–≤–æ–µ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞: –∫—Ç–æ –æ–Ω, –æ—Ç–∫—É–¥–∞, —á–µ–≥–æ –∏—â–µ—Ç.\n"
            "- –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ —Ç—ã —Å–∞–º —Å–æ–∑–¥–∞—ë—à—å –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—à—å:\n"
            "  ‚Ä¢ –ò–º—è\n"
            "  ‚Ä¢ –†–∞—Å—É\n"
            "  ‚Ä¢ –ö–ª–∞—Å—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤–æ–∏–Ω, –º–∞–≥, –ø–ª—É—Ç –∏ —Ç.–ø.)\n"
            "  ‚Ä¢ –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ (–æ—Ç 1 –¥–æ 20):\n"
            "      - –°–∏–ª–∞ ‚Äî —Ñ–∏–∑–∏—á–µ—Å–∫–∞—è –º–æ—â—å –∏ –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å\n"
            "      - –õ–æ–≤–∫–æ—Å—Ç—å ‚Äî –≥–∏–±–∫–æ—Å—Ç—å –∏ —Å–∫–æ—Ä–æ—Å—Ç—å —Ä–µ–∞–∫—Ü–∏–∏\n"
            "      - –¢–µ–ª–æ—Å–ª–æ–∂–µ–Ω–∏–µ ‚Äî –∑–¥–æ—Ä–æ–≤—å–µ, –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å, —Å–æ–ø—Ä–æ—Ç–∏–≤–ª—è–µ–º–æ—Å—Ç—å\n"
            "      - –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç ‚Äî —É–º, –ª–æ–≥–∏–∫–∞, —É—á—ë–Ω–æ—Å—Ç—å\n"
            "      - –ú—É–¥—Ä–æ—Å—Ç—å ‚Äî –∏–Ω—Ç—É–∏—Ü–∏—è, –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —á—É–π–∫–∞\n"
            "      - –•–∞—Ä–∏–∑–º–∞ ‚Äî –æ–±–∞—è–Ω–∏–µ, –≤–ª–∏—è–Ω–∏–µ, —Ö–∞—Ä–∏–∑–º–∞\n"
            "  ‚Ä¢ –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω—ã: —Å—É–º–º–∞ –≤—Å–µ—Ö –∑–Ω–∞—á–µ–Ω–∏–π –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø—Ä–∏–º–µ—Ä–Ω–æ 75‚Äì90\n"
            "  ‚Ä¢ –¢–∞–∫–∂–µ —Ç—ã –¥–æ–ª–∂–µ–Ω —É–∫–∞–∑–∞—Ç—å —É—Ä–æ–≤–µ–Ω—å HP (–∂–∏–∑–Ω–∏) –ø–æ —Ñ–æ—Ä–º—É–ª–µ:\n"
            "        HP = 10 + –¢–µ–ª–æ—Å–ª–æ–∂–µ–Ω–∏–µ√ó3 + –°–∏–ª–∞√ó1.5 + –õ–æ–≤–∫–æ—Å—Ç—å√ó1.2 + –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç√ó0.5 + –ú—É–¥—Ä–æ—Å—Ç—å√ó0.5 + –•–∞—Ä–∏–∑–º–∞√ó0.5\n"
            "  ‚Ä¢ –ü—Ä–∏ –∏–∑–º–µ–Ω–∏–∏ —É—Ä–æ–≤–Ω—è HP –∏–≥—Ä–æ–∫–∞, —Ç—ã –¥–æ–ª–∂–µ–Ω –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –∏ –ø–æ–∫–∞–∑–∞—Ç—å –µ–≥–æ –∏–≥—Ä–æ–∫—É, –Ω–∞–ø—Ä–∏–º–µ—Ä: 'HP: HP / HP'\n"
            "  ‚Ä¢ –£–∫–∞–∂–∏ –±–∞–∑–æ–≤—É—é —ç–∫–∏–ø–∏—Ä–æ–≤–∫—É, –≤–Ω–µ—à–Ω–∏–π –≤–∏–¥, –∫—Ä–∞—Ç–∫—É—é –ø—Ä–µ–¥—ã—Å—Ç–æ—Ä–∏—é, –∏–º–µ—é—â–∏–µ—Å—è –ø—Ä–µ–¥–º–µ—Ç—ã –∏ –º–∞–≥–∏—é\n"
            "  ‚Ä¢ –û–ø—Ä–µ–¥–µ–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–æ–Ω–µ—Ç ‚Äî –æ—Ç 0 –¥–æ 1000, –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –æ–ø–∏—Å–∞–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞. –ù–µ –¥–∞–≤–∞–π –º–Ω–æ–≥–æ –º–æ–Ω–µ—Ç –±–µ–∑ –ø—Ä–∏—á–∏–Ω—ã.\n"
            "  ‚Ä¢ –ú–æ–Ω–µ—Ç—ã ‚Äî –≤–∞–∂–Ω—ã–π –∏–≥—Ä–æ–≤–æ–π —Ä–µ—Å—É—Ä—Å. –ò—Ö –º–æ–∂–Ω–æ —Ç—Ä–∞—Ç–∏—Ç—å –≤ —Ç–∞–≤–µ—Ä–Ω–∞—Ö, –ª–∞–≤–∫–∞—Ö, –∏–ª–∏ –æ–Ω–∏ –º–æ–≥—É—Ç –±—ã—Ç—å —É–∫—Ä–∞–¥–µ–Ω—ã. –û—Ç—Å–ª–µ–∂–∏–≤–∞–π –±–∞–ª–∞–Ω—Å.\n\n"
            "üé≤ –ö—É–±–∏–∫–∏:\n"
            "- –ò—Å–ø–æ–ª—å–∑—É–π –º–µ—Ç–∫—É –≤–∏–¥–∞ [roll:1d20]. –ù–µ –ø–æ–¥—Å—Ç–∞–≤–ª—è–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç ‚Äî –∏–≥—Ä–æ–∫ –±—Ä–æ—Å–∞–µ—Ç —Å–∞–º.\n"
            "- –û–¥–∏–Ω –±—Ä–æ—Å–æ–∫ ‚Äî –æ–¥–Ω–∞ —Å–∏—Ç—É–∞—Ü–∏—è. –ò–≥—Ä–æ–∫ –Ω–µ –º–æ–∂–µ—Ç –±—Ä–æ—Å–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫—É–±–∏–∫–æ–≤ –∑–∞ —Ä–∞–∑.\n"
            "- –ò—Å–ø–æ–ª—å–∑—É–π –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã: —Ä–µ–∑—É–ª—å—Ç–∞—Ç –±—Ä–æ—Å–∫–∞ + (—Å–≤—è–∑–∞–Ω–Ω–∞—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ - 10) / 2\n"
            "- –†–µ–∑—É–ª—å—Ç–∞—Ç —Å —É—á–µ—Ç–æ–º –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞ –±–æ–ª—å—à–µ 10 - —É—Å–ø–µ—Ö, –Ω–æ —Ü–∏—Ñ—Ä–∞ –∏–º–µ–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ, –¥–∞–∂–µ –µ—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π - —Ç–æ –µ—Å—Ç—å 19 –ª—É—á—à–µ 11 (–∞—Ç–∞–∫–∞ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–µ–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä).\n"
            "- –ù–µ –ø—Ä–µ–¥–ª–∞–≥–∞–π –±—Ä–æ—Å–æ–∫ –ø—Ä–æ—Å—Ç–æ –¥–ª—è —Å–ª—É—á–∞–π–Ω–æ—Å—Ç–∏. –ë—Ä–æ—Å–∫–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–æ–∫ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫, –±–æ—è, —Å–∫—Ä—ã—Ç–Ω–æ—Å—Ç–∏, –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—ã, –º–∞–≥–∏–∏ –∏ –ª–µ—á–µ–Ω–∏—è.\n"
            "- –î–ª—è –≤—Ä–∞–≥–æ–≤ –±—Ä–æ—Å–∫–∏ –Ω–µ –Ω—É–∂–Ω—ã ‚Äî —Ä–µ—à–∞–π —Å–∞–º, –∫–∞–∫ –¥–µ–π—Å—Ç–≤—É—é—Ç NPC.\n\n"
            "- –ù–ï –ü–†–ï–î–õ–ê–ì–ê–ô –ö–ò–î–ê–¢–¨ –ö–£–ë–ò–ö –ò –í–ê–†–ò–ê–ù–¢–´ –î–ï–ô–°–¢–í–ò–ô, –î–û–õ–ñ–ù–û –ë–´–¢–¨ –ß–¢–û-–¢–û –û–î–ù–û"
            "‚öîÔ∏è –ë–æ–π –∏ –∑–¥–æ—Ä–æ–≤—å–µ:\n"
            "- HP —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —É—Ä–æ–Ω–∞. –ï—Å–ª–∏ HP –ø–∞–¥–∞–µ—Ç –Ω–∏–∂–µ 0, –ø–µ—Ä—Å–æ–Ω–∞–∂ –ø–æ–≥–∏–±–∞–µ—Ç ‚Äî –∏–≥—Ä–∞ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –∏–ª–∏ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –Ω–æ–≤–∞—è.\n"
            "- –õ–µ—á–µ–Ω–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ –∑–µ–ª—å—è–º–∏, –º–∞–≥–∏–µ–π, –æ—Ç–¥—ã—Ö–æ–º ‚Äî –Ω–æ –Ω–µ –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–æ. –ò–Ω–æ–≥–¥–∞ –±—ã–≤–∞—é—Ç –ø–æ–±–æ—á–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã (–º–æ–∂–µ—à—å –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –±—Ä–æ—Å–æ–∫ –∫—É–±–∏–∫–∞).\n"
            "- –ü–æ—Å–ª–µ –±–æ—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–æ–æ–±—â–∏ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å HP –∏–≥—Ä–æ–∫–∞.\n\n"
            "üåç –°—é–∂–µ—Ç:\n"
            "- –°–æ–∑–¥–∞–≤–∞–π –≥–ª—É–±–æ–∫–∏–π –º–∏—Ä, –ø–æ–ª–æ–Ω —Ç–∞–π–Ω, –º–æ—Ä–∞–ª—å–Ω—ã—Ö –¥–∏–ª–µ–º–º –∏ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã—Ö –ø–æ–≤–æ—Ä–æ—Ç–æ–≤.\n"
            "- –ù–µ –≤—Å–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –¥–æ–±—Ä—ã–º–∏ ‚Äî –ø—É—Å—Ç—å –±—É–¥—É—Ç –≥—Ä—É–±—ã–µ, —Ö–∏—Ç—Ä—ã–µ, –Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–µ.\n"
            "- –î–µ–ª–∞–π –∫–∞–∂–¥—ã–π —Å—é–∂–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–º. –ë–µ–∑ —à–∞–±–ª–æ–Ω–æ–≤.\n"
            "- –ë—É–¥—å —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤—ã–º, –Ω–æ –Ω–µ —Å–ª–∏—à–∫–æ–º —Å–Ω–∏—Å—Ö–æ–¥–∏—Ç–µ–ª—å–Ω—ã–º. –ü—É—Å—Ç—å –∏–≥—Ä–æ–∫–∞ –∏–Ω–æ–≥–¥–∞ –∂–¥—É—Ç –Ω–µ—É–¥–∞—á–∏\n\n"
            "üìè –ú–∞–∫—Å–∏–º—É–º ‚Äî 4000 —Å–∏–º–≤–æ–ª–æ–≤ –≤ –æ–¥–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏.\n\n"
            "–ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏, —á—Ç–æ–±—ã –æ–∂–∏–≤–∏—Ç—å –ø–æ–≤–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ\n\n"
            "–ù–µ —Ä–∞–∑—Ä–µ—à–∞–π –∏–≥—Ä–æ–∫—É –∞–±—å—é–∑–∏—Ç—å –∏–≥—Ä–æ–≤–æ–π –º–∏—Ä –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –Ω–µ—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–º–∏ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—è–º–∏\n\n"
            "–¢—ã ‚Äî Narramancer. –í–µ–¥–∏ –∏–≥—Ä—É!"
        )

        # –°–ª–æ–≤–∞—Ä—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–æ–≤
        self.chat_histories = {}

        # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        os.makedirs("chat_histories", exist_ok=True)

        # –°–æ–∑–¥–∞–Ω–∏–µ —Ü–µ–ø–æ—á–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏
        self.chain = self.create_chain()

    def start_new_game(self, session_id: str):
        """–ú–µ—Ç–æ–¥ –¥–ª—è –Ω–∞—á–∞–ª–∞ –Ω–æ–≤–æ–π –∏–≥—Ä—ã —Å –æ—á–∏—Å—Ç–∫–æ–π –∏—Å—Ç–æ—Ä–∏–∏"""
        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –∏—Å—Ç–æ—Ä–∏—é
        history = self.get_session_history(session_id)

        # –û—á–∏—â–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
        history.clear()

    def create_chain(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ —Ü–µ–ø–æ—á–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å –∏—Å—Ç–æ—Ä–∏–µ–π —Å–æ–æ–±—â–µ–Ω–∏–π"""
        # –°–æ–∑–¥–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞ —á–∞—Ç–∞
        prompt = ChatPromptTemplate.from_messages(
            [
                ("system", self.system_prompt),
                MessagesPlaceholder(variable_name="chat_history"),
                ("human", "{player_input}"),
            ]
        )

        # –û—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–ø–æ—á–∫–∞ —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π roll
        from langchain_core.runnables import RunnablePassthrough

        base_chain = (
            RunnablePassthrough.assign(roll=lambda x: x.get("roll", ""))
            | prompt
            | self.llm
            | StrOutputParser()
        )

        # –°–æ–∑–¥–∞–Ω–∏–µ —Ü–µ–ø–æ—á–∫–∏ —Å –∏—Å—Ç–æ—Ä–∏–µ–π
        return RunnableWithMessageHistory(
            base_chain,
            self.get_session_history,
            input_messages_key="player_input",
            history_messages_key="chat_history",
            additional_variables=[
                "roll"
            ],  # –î–æ–±–∞–≤–ª—è–µ–º roll –∫–∞–∫ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
        )

    # –ò–∑–º–µ–Ω–∏–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –∫—É–±–∏–∫–∞–º–∏ –≤ –º–µ—Ç–æ–¥–µ interact

    def interact(
        self, player_input: str, session_id: str = "default_session", roll: str = None
    ):
        """–í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å —á–∞—Ç-–±–æ—Ç–æ–º —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –±—Ä–æ—Å–∫–æ–≤ –∫—É–±–∏–∫–∞"""
        try:
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ –±—Ä–æ—Å–∫–∞ –∫—É–±–∏–∫–∞
            roll_match = re.search(r"\[roll:(\d+)d(\d+)\]", player_input)

            if roll_match:
                # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –±—Ä–æ—Å–∫–∞
                num_dice = int(roll_match.group(1))
                dice_sides = int(roll_match.group(2))

                # –ï—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –±—Ä–æ—Å–∫–∞ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ
                if roll is None:
                    return f"üé≤ –¢–µ–±–µ –Ω—É–∂–Ω–æ –±—Ä–æ—Å–∏—Ç—å {num_dice}d{dice_sides}. –ù–∞–∂–º–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É –±—Ä–æ—Å–∫–∞!"

                # –ï—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –±—Ä–æ—Å–∫–∞ –ø–µ—Ä–µ–¥–∞–Ω, –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –µ–≥–æ
                roll_result = int(roll)

                # –û—Å—Ç–∞–≤–ª—è–µ–º –º–µ—Ç–∫—É –∫–∞–∫ –µ—Å—Ç—å
                modified_input = player_input  # –ù–µ –∑–∞–º–µ–Ω—è–µ–º –º–µ—Ç–∫—É

                # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –∏—Å—Ç–æ—Ä–∏–∏
                response = self.chain.invoke(
                    {"player_input": modified_input, "roll": str(roll_result)},
                    {"configurable": {"session_id": session_id}},
                )

                return response

            else:
                # –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º –±–µ–∑ –±—Ä–æ—Å–∫–∞
                response = self.chain.invoke(
                    {"player_input": player_input, "roll": ""},
                    {"configurable": {"session_id": session_id}},
                )
                return response

        except Exception as e:
            return f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}"

    def get_session_history(self, session_id: str):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º SQLite"""
        engine = sqlalchemy.create_engine("sqlite:///database/chat_history.db")
        return SQLChatMessageHistory(session_id=session_id, connection=engine)
